var wm=wm||{};(function(e){var t;wm.media=t={};wml10n=wp.media.view.l10n;_.extend(t,{model:{},view:{},controller:{},frames:{}});WorkMatesUser=wm.media.model.WorkMatesUser=Backbone.Model.extend({defaults:{id:0,avatar:"",name:""}});WorkMatesUsers=wm.media.model.WorkMatesUsers=Backbone.Collection.extend({model:WorkMatesUser,initialize:function(){this.options={current_page:1,total_page:0}},sync:function(e,n,r){if("read"===e){r=r||{};r.context=this;r.data=_.extend(r.data||{},{action:"workmates_get_users",query:{group_id:wp.media.view.settings.group,page:this.options.current_page,search_terms:t.frame().state().get("search")},_wpnonce:wp.media.view.settings.nonce.workmates});return wp.ajax.send(r)}},parse:function(e,t){if(!_.isArray(e.items))e.items=[e.items];_.each(e.items,function(t,n){if(_.isNull(t))return;e.items[n].id=t.id;e.items[n].avatar=t.avatar;e.items[n].name=t.name});if(!_.isUndefined(e.meta)){this.options.current_page=e.meta.current_page;this.options.total_page=e.meta.total_page}return e.items}});t.view.WorkMatesUser=wp.media.View.extend({className:"workmates-users attachment",tagName:"li",template:wp.media.template("workmates"),render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});t.view.WorkMatesUsers=wp.media.View.extend({className:"list-workmates-users",tagName:"ul",events:{"click .attachment-preview":"toggleSelectionHandler","click .workmates-users .check":"removeSelectionHandler"},initialize:function(){if(this.views.length)this.views.remove();this.collection.reset();this.collection.fetch();this.collection.on("add error",this.displayUsers,this);this.controller.state().on("change:search",this.updateContent,this);this.controller.state().on("change:pagination",this.updateContent,this);this.getSelection().on("reset",this.clearItems,this)},updateContent:function(e){this.removeContent();this.collection.reset();this.collection.fetch()},removeContent:function(){_.each(this.users,function(e){e.remove()},this);this.users=[]},displayUsers:function(n){var r=this,i=this.getSelection();if(_.isUndefined(this.users))this.users=[];if(_.isUndefined(this.collection)||this.collection.length==0||!n){content=new t.view.WorkMatesUser({controller:this.controller,model:new Backbone.Model({notfound:1})});if(!this.users[0]){this.users[0]=content;this.views.add(content)}}else if(n){content=new t.view.WorkMatesUser({controller:this.controller,model:n});if(_.isUndefined(this.users[content.model.id])){this.users[content.model.id]=content;this.views.add(content)}}else{_.each(this.collection.models,function(e){content=new t.view.WorkMatesUser({controller:this.controller,model:e});r.users[content.model.id]=content;r.views.add(content)})}i.each(function(e){var t="#user-"+e.get("id");this.$el.find(t).parent("li").addClass("selected details")},this);if(e(".workmates-users").length&&e(".workmates-users").length>=2)e(".workmates-users").find("#workmates-error").parent().remove()},removeSelectionHandler:function(e){var t=jQuery("#"+e.currentTarget.id);var n=t.attr("data-id");this.removeFromSelection(t,n);e.preventDefault()},toggleSelectionHandler:function(e){if(e.target.href)return;var t=jQuery("#"+e.currentTarget.id);var n=t.attr("data-id");if(this.getSelection().get(n))this.removeFromSelection(t,n);else this.addToSelection(t,n)},addToSelection:function(e,t){e.closest(".workmates-users").addClass("selected details");this.getSelection().add(this.collection._byId[t]);this.controller.state().props.trigger("change:selection")},removeFromSelection:function(t,n){t.closest(".workmates-users").removeClass("selected details");if(e("#workmates-list li#uid-"+n).length){e("#workmates-list li#uid-"+n).remove()}this.getSelection().remove(this.collection._byId[n]);this.controller.state().props.trigger("change:selection")},getSelection:function(){return this.controller.state().props.get("_all").get("selection")},clearItems:function(){this.$el.find(".workmates-users").removeClass("selected details")}});t.view.WorkMates=wp.media.View.extend({className:"workmates-frame",tagName:"div",initialize:function(){var e=this.options.tab.id,t=this.options.tab.tpl;this.createSteps();this.createSidebar()},createSidebar:function(){this.sidebar=new t.view.WorkmatesPaginate({controller:this.controller});this.views.add(this.sidebar);this.sidebar.set("search",new t.view.WorkmatesSearch({controller:this.controller,collection:this.model.get("wmusers"),model:this.model,priority:80}))},createSteps:function(){var e;if(this.options.tab.id=="wmtab"){e=this.wmusers=new t.view.WorkMatesUsers({controller:this.controller,collection:this.model.get("wmusers"),model:this.model,tab:this.options.tab})}this.views.add(e)}});t.controller.WorkMates=wp.media.controller.State.extend({defaults:{id:"workmates",menu:"default",content:"wmtab",router:"steps",toolbar:"wm_insert",tabs:{wmtab:{tpl:"workmates",text:wml10n.wmTab,priority:20,id:"wmtab"}},search:""},initialize:function(){this.props=new Backbone.Collection;this.props.add(new Backbone.Model({id:"_all",selection:new Backbone.Collection,mirror:new Backbone.Collection}));this.props.on("change:selection",this.observeChanges,this);if(!this.get("wmusers"))this.set("wmusers",new WorkMatesUsers);this.get("wmusers").on("add",this.fillMirror,this)},fillMirror:function(e,n,r){var i=t.frame().state().props.get("_all").get("mirror");if(!i||!i.get(e.id))i.add(e)},activate:function(){var e=this.get("wmusers");this.frame.on("content:render:wmtab",this.manageWhoTab,this)},observeChanges:function(e){this.frame.toolbar.get().refresh()},manageWhoTab:function(e){this.set("content","wmtab");this.frame.toolbar.get().refresh()},nextPage:function(){this.get("wmusers").options.current_page+=1;this.trigger("change:pagination")},prevPage:function(){this.get("wmusers").options.current_page-=1;this.trigger("change:pagination")},wmInsert:function(){var t=this.props.get("_all").get("selection"),n="";t.each(function(e){n+='<li class="workmates-invited mine" id="uid-'+e.get("id")+'"> '+"\n";n+='<input type="hidden" name="workmates[]" value="'+e.get("id")+'"/>';n+='<img src="'+e.get("avatar")+'" class="avatar" width="50px" heigh="50px">'+"\n";n+="<h4>"+e.get("name")+"</h4>"+"\n";n+='<span class="activity">&nbsp;</span>'+"\n";n+='<div class="action">'+"\n";n+='<a class="button workmates-remove no-ajax" href="#" data-id="'+e.get("id")+'"> '+wml10n.removeInviteBtn+" </a>"+"\n";n+="</div>"+"\n";n+="</li>"+"\n"},this);wm.media.workmatesShowList();e("#workmates-list li").each(function(t){if(e(this).find("a.workmates-remove").hasClass("no-ajax"))e(this).remove()});e("#workmates-list").append(n);this.frame.close()}});t.view.ToolbarWorkMates=wp.media.view.Toolbar.extend({initialize:function(){_this=this;_.defaults(this.options,{event:"inserter",close:false,items:{inserter:{id:"wm-button",style:"primary",text:wml10n.wmInsertBtn,priority:80,click:function(){this.controller.state().wmInsert()}}}});wp.media.view.Toolbar.prototype.initialize.apply(this,arguments);this.set("userSelection",new t.view.WorkmatesUserSelection({controller:t.frame(),collection:this.controller.state().props.get("_all").get("selection"),priority:-40,editable:false}))},refresh:function(){var t=true;if(this.controller.state().get("content")=="wmtab"){var n=this.controller.state().props.get("_all").get("selection");t=!n.length;if(t&&!e("#workmates-list li.mine").length){e("#send-invite-form #submit").hide()}}this.get("inserter").model.set("disabled",t)}});t.view.WorkmatesPaginate=wp.media.view.Toolbar.extend({initialize:function(){_this=this;_.defaults(this.options,{event:"pagination",close:false,items:{next:{id:"wm-next",style:"secondary",text:wml10n.wmNextBtn,priority:-60,click:function(){this.controller.state().nextPage()}},prev:{id:"wm-prev",style:"secondary",text:wml10n.wmPrevBtn,priority:-80,click:function(){this.controller.state().prevPage()}}}});wp.media.view.Toolbar.prototype.initialize.apply(this,arguments);this.controller.state().get("wmusers").on("sync",this.refresh,this)},refresh:function(){var e=hasprev=false,t=this.controller.state().get("wmusers").options.total_page,n=this.controller.state().get("wmusers").options.current_page;if(this.controller.state().get("content")=="wmtab"&&t>0){e=Number(t)-Number(n)>0?true:false;hasprev=Number(n)-1>0?true:false}this.get("next").model.set("disabled",!e);this.get("prev").model.set("disabled",!hasprev)}});t.view.WorkmatesSearch=wp.media.view.Search.extend({attributes:{type:"search",placeholder:wml10n.wmSrcPlaceHolder},events:{keyup:"searchUser"},initialize:function(){wp.media.view.Search.prototype.initialize.apply(this,arguments)},searchUser:function(e){if(e.keyCode!=13)return;if(e.target.value)this.model.set("search",e.target.value);else this.model.unset("search");this.collection.options.current_page=1;this.model.trigger("change:search")}});t.view.WorkmatesUserSelection=wp.media.View.extend({tagName:"div",className:"user-selection",template:wp.media.template("user-selection"),events:{"click .clear-selection":"clear"},initialize:function(){_.defaults(this.options,{editable:false,clearable:true});this.collection.on("add remove reset",this.refresh,this);this.controller.on("content:activate",this.refresh,this)},refresh:function(){if(!this.$el.children().length)return;var e=this.collection,t=this.$el,n="";if(!e.length){t.addClass("empty");t.find(".selection-view ul").html("");t.find(".selection-info .count").html("");return}else{t.removeClass("empty")}t.find(".selection-info .count").html(wml10n.invited.replace("%d",e.length));e.each(function(e){var r=e.get("avatar");var i=e.get("id");var s=e.get("name");n+='<li class="user-avatar"><img src="'+r+'" title="'+s+'"></li>';t.find(".selection-view ul").html(n)},this)},clear:function(t){t.preventDefault();if(this.collection.length){this.collection.each(function(t){if(e("#workmates-list li#uid-"+t.get("id")).length){e("#workmates-list li#uid-"+t.get("id")).remove()}},this)}this.collection.reset();this.controller.state().props.trigger("change:selection")}});t.view.stepsItem=wp.media.view.RouterItem.extend({initialize:function(){wp.media.view.RouterItem.prototype.initialize.apply(this,arguments)}});t.view.stepsRouter=wp.media.view.Router.extend({ItemView:t.view.stepsItem,initialize:function(){wp.media.view.Router.prototype.initialize.apply(this,arguments)}});t.buttonId="#workmates-select",_.extend(t,{frame:function(){if(this._frame)return this._frame;var e,n=this,r,i=[new t.controller.WorkMates({title:wml10n.wmMainTitle,id:"workmates"})];this._frame=wp.media({className:"media-frame",states:i,state:"workmates"});_.each(i,function(e){if(e.id=="workmates"){r=e.attributes.tabs;for(tab in e.attributes.tabs){n._frame.on("content:render:"+tab,_.bind(n.wmContentRender,this,e.attributes.tabs[tab]))}}});this._frame.on("open",this.open);this._frame.on("router:create:steps",this.createRouter,this);this._frame.on("router:render:steps",_.bind(this.stepsRouter,this,r));this._frame.on("toolbar:create:wm_insert",_.bind(this.wmToolbarCreate,this,r));return this._frame},createRouter:function(e){e.view=new t.view.stepsRouter({controller:this._frame})},stepsRouter:function(e,t){var n={};for(var r in e){n[r]={text:e[r].text,priority:e[r].priority}}t.set(n)},wmContentRender:function(e){t.frame().content.set(new wm.media.view.WorkMates({controller:t.frame(),model:t.frame().state(),tab:e}))},wmToolbarCreate:function(e,n){n.view=new wm.media.view.ToolbarWorkMates({controller:t.frame(),tab:e})},open:function(){e(".media-modal").addClass("no-sidebar smaller")},workmatesHideList:function(){if(e("#workmates-list li").length==0){e("#workmates-list").hide();e("#send-invite-form #submit").hide()}else if(e("#workmates-list li.mine").length==0){e("#send-invite-form #submit").hide()}},workmatesShowList:function(){e("#workmates-list").show();e("#send-invite-form #submit").show()},init:function(){t.workmatesHideList();e(t.buttonId).on("click",function(e){e.preventDefault();t.frame().open()})}});e(t.init);e("#workmates-list").on("click",".workmates-remove",function(n){n.preventDefault();var r=e(this).data("id");if(e(this).hasClass("no-ajax")){var i=t.frame().state().props.get("_all").get("mirror");selection=t.frame().state().props.get("_all").get("selection");if(e("#user-"+r).length){e("#user-"+r).closest(".workmates-users").removeClass("selected details")}selection.remove(i._byId[r]);t.frame().state().props.trigger("change:selection");e(this).closest(".workmates-invited").remove();wm.media.workmatesHideList()}else{var s=e(this);wp.ajax.post("workmates_uninvite_user",{workmate_id:r,group_id:wp.media.view.settings.group,_wpnonce:wp.media.view.settings.nonce.workmates}).done(function(t){e("#buddypress div#message").slideUp(100).remove();e("#item-nav").prepend(t);e("#buddypress div#message").hide().fadeIn(200);s.closest(".workmates-invited").remove();wm.media.workmatesHideList()}).fail(function(t){e("#buddypress div#message").slideUp(100).remove();e("#item-nav").prepend(t);e("#buddypress div#message").hide().fadeIn(200)})}})})(jQuery)