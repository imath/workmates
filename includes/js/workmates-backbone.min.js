var wm=wm||{};!function(e){var t;wm.media=t={},wml10n=wp.media.view.l10n,_.extend(t,{model:{},view:{},controller:{},frames:{}}),WorkMatesUser=wm.media.model.WorkMatesUser=Backbone.Model.extend({defaults:{id:0,avatar:"",name:""}}),WorkMatesUsers=wm.media.model.WorkMatesUsers=Backbone.Collection.extend({model:WorkMatesUser,initialize:function(){this.options={current_page:1,total_page:0}},sync:function(e,i,s){return"read"===e?(s=s||{},s.context=this,s.data=_.extend(s.data||{},{action:"workmates_get_users",query:{group_id:wp.media.view.settings.group,page:this.options.current_page,search_terms:t.frame().state().get("search"),member_type:t.frame().state().get("member_type")},_wpnonce:wp.media.view.settings.nonce.workmates}),wp.ajax.send(s)):void 0},parse:function(e,t){return _.isArray(e.items)||(e.items=[e.items]),_.each(e.items,function(t,i){_.isNull(t)||(e.items[i].id=t.id,e.items[i].avatar=t.avatar,e.items[i].name=t.name)}),_.isUndefined(e.meta)||(this.options.current_page=e.meta.current_page,this.options.total_page=e.meta.total_page),e.items}}),t.view.WorkMatesUser=wp.media.View.extend({className:"workmates-users attachment",tagName:"li",template:wp.media.template("workmates"),render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),t.view.WorkMatesUsers=wp.media.View.extend({className:"list-workmates-users",tagName:"ul",events:{"click .attachment-preview":"toggleSelectionHandler","click .workmates-users .check":"removeSelectionHandler"},initialize:function(){this.views.length&&this.views.remove(),this.collection.reset(),this.collection.fetch(),this.collection.on("add error",this.displayUsers,this),this.controller.state().on("change:search",this.updateContent,this),this.controller.state().on("change:member_type",this.updateContent,this),this.controller.state().on("change:pagination",this.updateContent,this),this.getSelection().on("reset",this.clearItems,this)},updateContent:function(e){this.removeContent(),this.collection.reset(),this.collection.fetch()},removeContent:function(){_.each(this.users,function(e){_.isUndefined(e)||e.remove()},this),this.users=[]},displayUsers:function(i){var s=this,r=this.getSelection();_.isUndefined(this.users)&&(this.users=[]),_.isUndefined(this.collection)||0==this.collection.length||!i?(content=new t.view.WorkMatesUser({controller:this.controller,model:new Backbone.Model({notfound:1})}),this.users[0]||(this.users[0]=content,this.views.add(content))):i?(content=new t.view.WorkMatesUser({controller:this.controller,model:i}),_.isUndefined(this.users[content.model.id])&&(this.users[content.model.id]=content,this.views.add(content))):_.each(this.collection.models,function(e){content=new t.view.WorkMatesUser({controller:this.controller,model:e}),s.users[content.model.id]=content,s.views.add(content)}),r.each(function(e){var t="#user-"+e.get("id");this.$el.find(t).parent("li").addClass("selected details")},this),e(".workmates-users").length&&e(".workmates-users").length>=2&&e(".workmates-users").find("#workmates-error").parent().remove()},removeSelectionHandler:function(e){var t=jQuery("#"+e.currentTarget.id),i=t.attr("data-id");this.removeFromSelection(t,i),e.preventDefault()},toggleSelectionHandler:function(e){if(!e.target.href){var t=jQuery("#"+e.currentTarget.id),i=t.attr("data-id");this.getSelection().get(i)?this.removeFromSelection(t,i):this.addToSelection(t,i)}},addToSelection:function(e,t){e.closest(".workmates-users").addClass("selected details"),this.getSelection().add(this.collection._byId[t]),this.controller.state().props.trigger("change:selection")},removeFromSelection:function(t,i){t.closest(".workmates-users").removeClass("selected details"),e("#workmates-list li#uid-"+i).length&&e("#workmates-list li#uid-"+i).remove(),this.getSelection().remove(this.collection._byId[i]),this.controller.state().props.trigger("change:selection")},getSelection:function(){return this.controller.state().props.get("_all").get("selection")},clearItems:function(){this.$el.find(".workmates-users").removeClass("selected details")}}),t.view.WorkMates=wp.media.View.extend({className:"workmates-frame",tagName:"div",initialize:function(){this.options.tab.id,this.options.tab.tpl;this.createSteps(),this.createSidebar()},createSidebar:function(){this.sidebar=new t.view.WorkmatesPaginate({controller:this.controller}),this.views.add(this.sidebar),this.sidebar.set("search",new t.view.WorkmatesSearch({controller:this.controller,collection:this.model.get("wmusers"),model:this.model,priority:80})),_.isUndefined(wp.media.view.settings.wmMemberTypes)||this.sidebar.set("typeFilter",new t.view.WorkmatesTypeFilter({controller:this.controller,collection:this.model.get("wmusers"),model:this.model,priority:-60}).render())},createSteps:function(){var e;"wmtab"==this.options.tab.id&&(e=this.wmusers=new t.view.WorkMatesUsers({controller:this.controller,collection:this.model.get("wmusers"),model:this.model,tab:this.options.tab})),this.views.add(e)}}),t.controller.WorkMates=wp.media.controller.State.extend({defaults:{id:"workmates",menu:"default",content:"wmtab",router:"steps",toolbar:"wm_insert",tabs:{wmtab:{tpl:"workmates",text:wml10n.wmTab,priority:20,id:"wmtab"}},search:"",member_type:""},initialize:function(){this.props=new Backbone.Collection,this.props.add(new Backbone.Model({id:"_all",selection:new Backbone.Collection,mirror:new Backbone.Collection})),this.props.on("change:selection",this.observeChanges,this),this.get("wmusers")||this.set("wmusers",new WorkMatesUsers),this.get("wmusers").on("add",this.fillMirror,this)},fillMirror:function(e,i,s){var r=t.frame().state().props.get("_all").get("mirror");r&&r.get(e.id)||r.add(e)},activate:function(){this.get("wmusers");this.frame.on("content:render:wmtab",this.manageWhoTab,this)},observeChanges:function(e){this.frame.toolbar.get().refresh()},manageWhoTab:function(e){this.set("content","wmtab"),this.frame.toolbar.get().refresh()},nextPage:function(){this.get("wmusers").options.current_page+=1,this.trigger("change:pagination")},prevPage:function(){this.get("wmusers").options.current_page-=1,this.trigger("change:pagination")},wmInsert:function(){var t=this.props.get("_all").get("selection"),i="";t.each(function(e){i+='<li class="workmates-invited mine" id="uid-'+e.get("id")+'"> \n',i+='<input type="hidden" name="workmates[]" value="'+e.get("id")+'"/>',i+='<img src="'+e.get("avatar")+'" class="avatar" width="50px" heigh="50px">\n',i+="<h4>"+e.get("name")+"</h4>\n",i+='<span class="activity">&nbsp;</span>\n',i+='<div class="action">\n',i+='<a class="button workmates-remove no-ajax" href="#" data-id="'+e.get("id")+'"> '+wml10n.removeInviteBtn+" </a>\n",i+="</div>\n",i+="</li>\n"},this),wm.media.workmatesShowList(),e("#workmates-list li").each(function(t){e(this).find("a.workmates-remove").hasClass("no-ajax")&&e(this).remove()}),e("#workmates-list").append(i),this.frame.close()}}),t.view.ToolbarWorkMates=wp.media.view.Toolbar.extend({initialize:function(){_this=this,_.defaults(this.options,{event:"inserter",close:!1,items:{inserter:{id:"wm-button",style:"primary",text:wml10n.wmInsertBtn,priority:80,click:function(){this.controller.state().wmInsert()}}}}),wp.media.view.Toolbar.prototype.initialize.apply(this,arguments),this.set("userSelection",new t.view.WorkmatesUserSelection({controller:t.frame(),collection:this.controller.state().props.get("_all").get("selection"),priority:-40,editable:!1}))},refresh:function(){var t=!0;if("wmtab"==this.controller.state().get("content")){var i=this.controller.state().props.get("_all").get("selection");t=!i.length,t&&!e("#workmates-list li.mine").length&&e("#send-invite-form #submit").hide()}this.get("inserter").model.set("disabled",t)}}),t.view.WorkmatesPaginate=wp.media.view.Toolbar.extend({initialize:function(){_this=this,_.defaults(this.options,{event:"pagination",close:!1,items:{next:{id:"wm-next",style:"secondary",text:wml10n.wmNextBtn,priority:-60,click:function(){this.controller.state().nextPage()}},prev:{id:"wm-prev",style:"secondary",text:wml10n.wmPrevBtn,priority:-80,click:function(){this.controller.state().prevPage()}}}}),wp.media.view.Toolbar.prototype.initialize.apply(this,arguments),this.controller.state().get("wmusers").on("sync",this.refresh,this)},refresh:function(){var e=hasprev=!1,t=this.controller.state().get("wmusers").options.total_page,i=this.controller.state().get("wmusers").options.current_page;"wmtab"==this.controller.state().get("content")&&t>0&&(e=Number(t)-Number(i)>0?!0:!1,hasprev=Number(i)-1>0?!0:!1),this.get("next").model.set("disabled",!e),this.get("prev").model.set("disabled",!hasprev)}}),t.view.WorkmatesSearch=wp.media.view.Search.extend({attributes:{type:"search",placeholder:wml10n.wmSrcPlaceHolder},events:{keyup:"searchUser"},initialize:function(){wp.media.view.Search.prototype.initialize.apply(this,arguments)},searchUser:function(e){13==e.keyCode&&(e.target.value?this.model.set("search",e.target.value):this.model.unset("search"),this.collection.options.current_page=1,this.model.trigger("change:search"))}}),t.view.WorkmatesTypeFilter=wp.media.view.AttachmentFilters.extend({id:"member-type-filters",createFilters:function(){var e={};_.each(wp.media.view.settings.wmMemberTypes||{},function(t,i){e[i]={text:t.text,props:{type:t.type}}}),e.all={text:wp.media.view.settings.wmMemberTypesAll,props:{type:!1},priority:10},this.filters=e},change:function(){var e=this.filters[this.el.value];e?this.model.set("member_type",e.props.type):this.model.unset("member_type"),this.collection.options.current_page=1,this.model.trigger("change:member_type")},select:function(){var e=this.model,t="all",i=e.toJSON();_.find(this.filters,function(e,s){var r=_.all(e.props,function(e,t){return e===(_.isUndefined(i.member_type)?null:i.member_type)});return r?t=s:void 0}),this.$el.val(t)}}),t.view.WorkmatesUserSelection=wp.media.View.extend({tagName:"div",className:"user-selection",template:wp.media.template("user-selection"),events:{"click .clear-selection":"clear"},initialize:function(){_.defaults(this.options,{editable:!1,clearable:!0}),this.collection.on("add remove reset",this.refresh,this),this.controller.on("content:activate",this.refresh,this)},refresh:function(){if(this.$el.children().length){var e=this.collection,t=this.$el,i="";if(!e.length)return t.addClass("empty"),t.find(".selection-view ul").html(""),void t.find(".selection-info .count").html("");t.removeClass("empty"),t.find(".selection-info .count").html(wml10n.invited.replace("%d",e.length)),e.each(function(e){var s=e.get("avatar"),r=(e.get("id"),e.get("name"));i+='<li class="user-avatar"><img src="'+s+'" title="'+r+'"></li>',t.find(".selection-view ul").html(i)},this)}},clear:function(t){t.preventDefault(),this.collection.length&&this.collection.each(function(t){e("#workmates-list li#uid-"+t.get("id")).length&&e("#workmates-list li#uid-"+t.get("id")).remove()},this),this.collection.reset(),this.controller.state().props.trigger("change:selection")}}),t.view.stepsItem=wp.media.view.RouterItem.extend({initialize:function(){wp.media.view.RouterItem.prototype.initialize.apply(this,arguments)}}),t.view.stepsRouter=wp.media.view.Router.extend({ItemView:t.view.stepsItem,initialize:function(){wp.media.view.Router.prototype.initialize.apply(this,arguments)}}),t.buttonId="#workmates-select",_.extend(t,{frame:function(){if(this._frame)return this._frame;var e,i=this,s=[new t.controller.WorkMates({title:wml10n.wmMainTitle,id:"workmates"})];return this._frame=wp.media({className:"media-frame",states:s,state:"workmates"}),_.each(s,function(t){if("workmates"==t.id){e=t.attributes.tabs;for(tab in t.attributes.tabs)i._frame.on("content:render:"+tab,_.bind(i.wmContentRender,this,t.attributes.tabs[tab]))}}),this._frame.on("open",this.open),this._frame.on("router:create:steps",this.createRouter,this),this._frame.on("router:render:steps",_.bind(this.stepsRouter,this,e)),this._frame.on("toolbar:create:wm_insert",_.bind(this.wmToolbarCreate,this,e)),this._frame},createRouter:function(e){e.view=new t.view.stepsRouter({controller:this._frame})},stepsRouter:function(e,t){var i={};for(var s in e)i[s]={text:e[s].text,priority:e[s].priority};t.set(i)},wmContentRender:function(e){t.frame().content.set(new wm.media.view.WorkMates({controller:t.frame(),model:t.frame().state(),tab:e}))},wmToolbarCreate:function(e,i){i.view=new wm.media.view.ToolbarWorkMates({controller:t.frame(),tab:e})},open:function(){e(".media-modal").addClass("no-sidebar smaller")},workmatesHideList:function(){0==e("#workmates-list li").length?(e("#workmates-list").hide(),e("#send-invite-form #submit").hide()):0==e("#workmates-list li.mine").length&&e("#send-invite-form #submit").hide()},workmatesShowList:function(){e("#workmates-list").show(),e("#send-invite-form #submit").show()},init:function(){t.workmatesHideList(),e(t.buttonId).on("click",function(e){e.preventDefault(),t.frame().open()})}}),e(t.init),e("#workmates-list").on("click",".workmates-remove",function(i){i.preventDefault();var s=e(this).data("id");if(e(this).hasClass("no-ajax")){var r=t.frame().state().props.get("_all").get("mirror");selection=t.frame().state().props.get("_all").get("selection"),e("#user-"+s).length&&e("#user-"+s).closest(".workmates-users").removeClass("selected details"),selection.remove(r._byId[s]),t.frame().state().props.trigger("change:selection"),e(this).closest(".workmates-invited").remove(),wm.media.workmatesHideList()}else{var n=e(this);wp.ajax.post("workmates_uninvite_user",{workmate_id:s,group_id:wp.media.view.settings.group,_wpnonce:wp.media.view.settings.nonce.workmates}).done(function(t){e("#buddypress div#message").slideUp(100).remove(),e("#item-nav").prepend(t),e("#buddypress div#message").hide().fadeIn(200),n.closest(".workmates-invited").remove(),wm.media.workmatesHideList()}).fail(function(t){e("#buddypress div#message").slideUp(100).remove(),e("#item-nav").prepend(t),e("#buddypress div#message").hide().fadeIn(200)})}})}(jQuery);